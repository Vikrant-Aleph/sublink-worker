name: Sync Fork from Upstream

on:
  schedule:
    - cron: '0 4 * * *' # 每4小时
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Target Repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 
          token: ${{ github.token }}

      - name: Sync Upstream
        run: |
          UPSTREAM_URL="https://github.com/7Sageer/sublink-worker.git"
          BRANCH_NAME="main"

          git config --global user.name 'GitHub Action'
          git config --global user.email 'action@github.com'

          git remote add upstream "$UPSTREAM_URL"
          git fetch upstream
          git checkout "$BRANCH_NAME"
          
          # 合并上游代码
          git merge upstream/"$BRANCH_NAME" --no-edit || true

      # --- 【新增步骤】清理不需要的 Action 文件 ---
      - name: Remove Upstream Workflows
        run: |
          echo "正在清理上游的 workflow 文件..."
          
          # 逻辑：在 .github/workflows 目录下，
          # 找到所有文件 (-type f)
          # 排除掉 (! -name) 这个同步脚本本身 ('sync-fork.yml')
          # 然后把剩下的全部删除 (-delete)
          
          find .github/workflows -type f ! -name 'sync-fork.yml' -delete
          
          # 检查一下结果，看看是不是只剩 sync-fork.yml 了
          ls -R .github/workflows

      # ------------------------------------------

      - name: Push Changes
        run: |
          git add .github/workflows
          
          if git diff --staged --quiet; then
             echo "仓库已是最新，无变动。"
          else
             git commit -m "Merge upstream and remove external workflows"
             # 【推荐】直接推送当前分支，不需要变量
             git push origin HEAD
             echo "同步完成。"
          fi
